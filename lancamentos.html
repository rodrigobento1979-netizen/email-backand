<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema CTBIL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-600 p-3 rounded-lg">
                        <i class="fas fa-file-export text-2xl text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Sistema CTBIL</h1>
                        <p class="text-gray-600">Importação e geração de arquivo CTBIL</p>
                    </div>
                </div>
                <button onclick="ModeloPlanilha.gerarModelo()" 
                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                    <i class="fas fa-file-excel"></i>
                    Baixar Modelo
                </button>
            </div>
        </div>

        <!-- Upload Area -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="text-center">
                <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-file-excel text-3xl text-blue-600"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">Importar Planilha Excel</h3>
                
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 mb-4 hover:border-blue-400 transition-colors">
                    <input type="file" id="file-upload" accept=".xlsx,.xls" class="hidden">
                    <label for="file-upload" class="cursor-pointer">
                        <div class="text-center">
                            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
                            <p class="text-lg text-gray-600">
                                <span class="text-blue-600 font-medium">Clique para fazer upload</span> ou arraste o arquivo
                            </p>
                            <p class="text-sm text-gray-500 mt-1">Formatos suportados: .xlsx, .xls</p>
                        </div>
                    </label>
                </div>
                
                <div class="text-sm text-gray-500">
                    <p>Certifique-se de que a planilha contém as colunas:</p>
                    <p class="font-medium">Data, Documento, Conta Débito, Conta Crédito, Valor, HP, Histórico</p>
                </div>
            </div>
        </div>

        <!-- Lançamentos Table -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="bg-blue-600 text-white p-4">
                <h3 class="font-bold text-lg">
                    <i class="fas fa-list mr-2"></i>
                    Lançamentos Importados (<span id="lancamentos-count">0</span>)
                </h3>
            </div>

            <div class="p-4">
                <input type="text" id="search-input" placeholder="Buscar lançamentos..." 
                       class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-4">
            </div>

            <div class="overflow-x-auto max-h-96">
                <table class="w-full text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="p-2 text-left font-semibold">Data</th>
                            <th class="p-2 text-left font-semibold">Documento</th>
                            <th class="p-2 text-left font-semibold">Conta Débito</th>
                            <th class="p-2 text-left font-semibold">Conta Crédito</th>
                            <th class="p-2 text-left font-semibold">Valor</th>
                            <th class="p-2 text-left font-semibold">HP</th>
                            <th class="p-2 text-left font-semibold">Histórico</th>
                        </tr>
                    </thead>
                    <tbody id="lancamentos-table">
                        <tr>
                            <td colspan="7" class="p-4 text-center text-gray-500">
                                Nenhum lançamento importado
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="p-4 border-t">
                <button onclick="gerarCTBIL()" 
                        class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 ml-auto">
                    <i class="fas fa-file-export"></i>
                    Gerar CTBIL
                </button>
            </div>
        </div>
    </div>

    <script>
        let lancamentos = [];

        // Função para mostrar notificações Toastify
        const showToast = (message, type = 'success') => {
            const background = type === 'success' ? 'linear-gradient(to right, #00b09b, #96c93d)' : 
                              type === 'error' ? 'linear-gradient(to right, #ff5f6d, #ffc371)' : 
                              'linear-gradient(to right, #2193b0, #6dd5ed)';
            
            Toastify({
                text: message,
                duration: 3000,
                gravity: "top",
                position: "right",
                backgroundColor: background,
                stopOnFocus: true,
            }).showToast();
        };

        // Funções básicas de formatação
        const formatarData = (dataString) => {
            if (!dataString) return '';
            try {
                const strData = dataString.toString().trim();
                
                // Formato DD/MM/AAAA - GARANTIR ANO COM 4 DÍGITOS
                if (strData.includes('/')) {
                    const partes = strData.split('/');
                    if (partes.length === 3) {
                        let [dia, mes, ano] = partes.map(p => p.trim().padStart(2, '0'));
                        
                        // Garantir que o ano tenha 4 dígitos
                        if (ano.length === 2) {
                            ano = '20' + ano;
                        }
                        
                        return `${dia}/${mes}/${ano}`;
                    }
                }
                
                return strData;
            } catch (error) {
                return dataString?.toString() || '';
            }
        };

        const formatarDataCTBIL = (dataString) => {
            if (!dataString) return '00000000';
            try {
                const strData = dataString.toString().trim();
                
                // Converter de DD/MM/AAAA para AAAAMMDD
                if (strData.includes('/')) {
                    const partes = strData.split('/');
                    if (partes.length === 3) {
                        const [dia, mes, ano] = partes.map(p => p.trim().padStart(2, '0'));
                        // Já garantimos que o ano tem 4 dígitos na formatarData
                        return ano + mes + dia;
                    }
                }
                
                return '00000000';
            } catch (error) {
                return '00000000';
            }
        };

        const formatarDocumento = (documento) => {
            if (!documento) return '00000000';
            try {
                const apenasNumeros = documento.toString().replace(/\D/g, '');
                return apenasNumeros.padStart(8, '0');
            } catch (error) {
                return '00000000';
            }
        };

        const formatarValorExibicao = (valorStr) => {
            if (!valorStr) return '0,00';
            try {
                let valor = valorStr.toString().trim();
                if (valor.includes(',')) return valor;
                
                let numero = parseFloat(valor.replace(/[^\d,.-]/g, '').replace(',', '.'));
                if (isNaN(numero)) return '0,00';
                
                return numero.toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            } catch (error) {
                return '0,00';
            }
        };

        const converterValorParaCTBIL = (valorExibicao) => {
            if (!valorExibicao) return '0.00';
            try {
                return valorExibicao.toString()
                    .replace(/\./g, '')
                    .replace(',', '.');
            } catch (error) {
                return '0.00';
            }
        };

        // Gerador de CTBIL SIMPLIFICADO
        const CTBILGenerator = {
            generateCTBIL: (documentos) => {
                let ctbilContent = '';
                let numeroLancamento = 1;
                
                documentos.forEach((doc) => {
                    const numeroLancFormatado = numeroLancamento.toString().padStart(8, '0');
                    
                    // Data no formato AAAAMMDD
                    const dataLancamento = formatarDataCTBIL(doc.data);
                    
                    // Valor formatado para CTBIL (14 caracteres)
                    const valorCTBIL = converterValorParaCTBIL(doc.valor);
                    let valorFormatado = ' '.repeat(14);
                    try {
                        const valor = parseFloat(valorCTBIL) || 0;
                        if (valor !== 0) {
                            const valorStr = valor.toFixed(2);
                            const partes = valorStr.split('.');
                            valorFormatado = (partes[0].padStart(11, '0') + '.' + partes[1]).padStart(14, ' ');
                        }
                    } catch (error) {
                        // Silencioso - sem console.log
                    }
                    
                    // Histórico (50 caracteres) - REMOVER CARACTERES ESPECIAIS
                    let historicoFormatado = (doc.historico?.toString() || 'Lancamento automatico')
                        .substring(0, 50)
                        .normalize('NFD').replace(/[\u0300-\u036f]/g, '') // Remove acentos
                        .replace(/[^\w\s]/g, ' ') // Remove caracteres especiais, mantém espaços
                        .padEnd(50, ' ');
                    
                    // Contas (17 caracteres cada) - PRESERVA PONTOS
                    const contaDebitoFormatada = (doc.contaDebito?.toString() || '').padEnd(17, ' ');
                    const contaCreditoFormatada = (doc.contaCredito?.toString() || '').padEnd(17, ' ');
                    
                    // HP (3 caracteres)
                    const hp = (doc.hp?.toString() || '   ').padEnd(3, ' ');
                    
                    // Filiais (2 caracteres cada)
                    const filialDebito = '00';
                    const filialCredito = '00';
                    
                    // Montar linha (total deve ser 121 caracteres)
                    const linha = 
                        dataLancamento +                    // 8
                        numeroLancFormatado +              // 8
                        contaDebitoFormatada +             // 17
                        contaCreditoFormatada +            // 17
                        valorFormatado +                   // 14
                        hp +                               // 3
                        historicoFormatado +               // 50
                        filialDebito +                     // 2
                        filialCredito;                     // 2
                                                        // TOTAL: 121
                    
                    ctbilContent += linha + '\r\n';
                    numeroLancamento++;
                });
                
                return ctbilContent;
            },

            downloadCTBIL: (content, filename) => {
                try {
                    // Usar TextEncoder padrão (UTF-8) que é mais compatível
                    const encoder = new TextEncoder();
                    const data = encoder.encode(content);
                    const blob = new Blob([data], { type: 'text/plain;charset=utf-8' });
                    
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showToast(`Arquivo ${filename} gerado com sucesso!`, 'success');
                    return true;
                } catch (error) {
                    showToast('Erro ao gerar arquivo CTBIL: ' + error.message, 'error');
                    return false;
                }
            }
        };

        // Modelo de Planilha
        const ModeloPlanilha = {
            gerarModelo: () => {
                const dados = [
                    {
                        'Data': '15/01/2024',
                        'Documento': '00000001',
                        'Conta Débito': '1.1.1.01.001',
                        'Conta Crédito': '2.1.1.01.001', 
                        'Valor': '1500,00',
                        'HP': '001',
                        'Histórico': 'Pagamento de fornecedor'
                    },
                    {
                        'Data': '16/01/2024',
                        'Documento': '00000002',
                        'Conta Débito': '1.1.1.02.001',
                        'Conta Crédito': '2.1.1.02.001', 
                        'Valor': '2500,00',
                        'HP': '002',
                        'Histórico': 'Recebimento de cliente'
                    }
                ];

                const worksheet = XLSX.utils.json_to_sheet(dados);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Lançamentos");
                
                const colWidths = [
                    { wch: 12 }, { wch: 10 }, { wch: 15 }, { wch: 15 },
                    { wch: 12 }, { wch: 6 }, { wch: 25 }
                ];
                worksheet['!cols'] = colWidths;

                XLSX.writeFile(workbook, "modelo_lancamentos.xlsx");
                showToast('Modelo de planilha baixado com sucesso!', 'success');
            }
        };

        // Funções principais
        function importarPlanilha(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { raw: false });

                    if (jsonData.length === 0) {
                        showToast('A planilha está vazia ou não contém dados válidos', 'error');
                        return;
                    }

                    lancamentos = jsonData.map((row, index) => {
                        let dataRaw = row['Data'] || row['data'] || '';
                        let dataFormatada = formatarData(dataRaw.toString());

                        return {
                            id: Date.now() + index,
                            data: dataFormatada,
                            documento: formatarDocumento(row['Documento'] || row['documento'] || ''),
                            contaDebito: (row['Conta Débito'] || row['contaDebito'] || row['conta_debito'] || '').toString(),
                            contaCredito: (row['Conta Crédito'] || row['contaCredito'] || row['conta_credito'] || '').toString(),
                            valor: formatarValorExibicao(row['Valor'] || row['valor'] || ''),
                            hp: (row['HP'] || row['hp'] || '').toString(),
                            historico: (row['Histórico'] || row['historico'] || '').toString()
                        };
                    });

                    atualizarTabela();
                    showToast(`Planilha importada com ${lancamentos.length} lançamentos`, 'success');
                } catch (error) {
                    showToast('Erro ao importar arquivo Excel. Verifique o formato.', 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function atualizarTabela() {
            const tabela = document.getElementById('lancamentos-table');
            const countElement = document.getElementById('lancamentos-count');
            
            countElement.textContent = lancamentos.length;

            if (lancamentos.length === 0) {
                tabela.innerHTML = `
                    <tr>
                        <td colspan="7" class="p-4 text-center text-gray-500">
                            Nenhum lançamento importado
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';
            lancamentos.forEach(lancamento => {
                html += `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="p-2">${lancamento.data}</td>
                        <td class="p-2 font-mono">${lancamento.documento}</td>
                        <td class="p-2">${lancamento.contaDebito}</td>
                        <td class="p-2">${lancamento.contaCredito}</td>
                        <td class="p-2 text-right font-mono">${lancamento.valor}</td>
                        <td class="p-2">${lancamento.hp}</td>
                        <td class="p-2">${lancamento.historico}</td>
                    </tr>
                `;
            });
            tabela.innerHTML = html;
        }

        function gerarCTBIL() {
            if (lancamentos.length === 0) {
                showToast('Nenhum lançamento para gerar CTBIL', 'error');
                return;
            }

            try {
                const ctbilContent = CTBILGenerator.generateCTBIL(lancamentos);
                const filename = 'CTBIL001.TXT';
                CTBILGenerator.downloadCTBIL(ctbilContent, filename);
            } catch (error) {
                showToast('Erro ao gerar arquivo CTBIL: ' + error.message, 'error');
            }
        }

        // Event Listeners
        document.getElementById('file-upload').addEventListener('change', importarPlanilha);

        document.getElementById('search-input').addEventListener('input', function(e) {
            // Implementar busca se necessário
        });

        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            atualizarTabela();
        });
    </script>
</body>
</html>