<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema CTBIL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">
    <div class="max-w-6xl mx-auto">
        <!-- Cabeçalho -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <div class="bg-blue-600 p-3 rounded-lg">
                        <i class="fas fa-file-export text-white text-2xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">Sistema CTBIL</h1>
                        <p class="text-gray-600">Importação e geração de arquivo CTBIL</p>
                    </div>
                </div>
                <div class="flex space-x-3">
                    <button onclick="baixarModelo()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2">
                        <i class="fas fa-file-excel"></i>
                        <span>Modelo</span>
                    </button>
                    <button onclick="gerarCTBIL()" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2">
                        <i class="fas fa-file-export"></i>
                        <span>Gerar CTBIL</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Área Principal -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Painel de Upload -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-file-excel text-blue-600 text-2xl"></i>
                    </div>
                    <h2 class="text-xl font-bold text-gray-800 mb-2">Importar Planilha</h2>
                    <p class="text-gray-600 text-sm">Faça upload da planilha com os lançamentos</p>
                </div>

                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center mb-4 hover:border-blue-400 transition-colors cursor-pointer" onclick="document.getElementById('fileInput').click()">
                    <i class="fas fa-cloud-upload-alt text-gray-400 text-4xl mb-3"></i>
                    <p class="text-gray-700 font-medium">Clique para fazer upload</p>
                    <p class="text-gray-500 text-sm mt-1">Arraste ou clique para selecionar arquivo</p>
                    <p class="text-gray-400 text-xs mt-2">Formatos: .xlsx, .xls</p>
                </div>

                <input type="file" id="fileInput" accept=".xlsx,.xls" class="hidden" onchange="processarArquivo(event)">

                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <p class="text-blue-800 font-medium text-sm mb-2">Colunas necessárias na planilha:</p>
                    <p class="text-blue-700 text-xs">Data, Documento, Conta Débito, Conta Crédito, Valor, HP, Histórico</p>
                </div>
            </div>

            <!-- Tabela de Lançamentos -->
            <div class="bg-white rounded-lg shadow lg:col-span-2">
                <div class="bg-blue-600 text-white px-6 py-4 rounded-t-lg">
                    <div class="flex justify-between items-center">
                        <h2 class="text-lg font-bold flex items-center space-x-2">
                            <i class="fas fa-list"></i>
                            <span>Lançamentos Importados</span>
                        </h2>
                        <span class="bg-blue-500 px-3 py-1 rounded-full text-sm font-bold" id="contador">0</span>
                    </div>
                </div>

                <div class="p-4 border-b">
                    <div class="relative">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        <input type="text" id="campoBusca" placeholder="Buscar lançamentos..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <div class="overflow-x-auto max-h-96">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-4 py-3 text-left font-semibold text-gray-700 text-xs uppercase">Data</th>
                                <th class="px-4 py-3 text-left font-semibold text-gray-700 text-xs uppercase">Documento</th>
                                <th class="px-4 py-3 text-left font-semibold text-gray-700 text-xs uppercase">Conta Débito</th>
                                <th class="px-4 py-3 text-left font-semibold text-gray-700 text-xs uppercase">Conta Crédito</th>
                                <th class="px-4 py-3 text-left font-semibold text-gray-700 text-xs uppercase">Valor</th>
                                <th class="px-4 py-3 text-left font-semibold text-gray-700 text-xs uppercase">HP</th>
                                <th class="px-4 py-3 text-left font-semibold text-gray-700 text-xs uppercase">Histórico</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaLancamentos">
                            <tr>
                                <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                                    <div class="flex flex-col items-center justify-center">
                                        <i class="fas fa-inbox text-gray-300 text-4xl mb-3"></i>
                                        <p class="text-gray-500 font-medium">Nenhum lançamento importado</p>
                                        <p class="text-gray-400 text-sm">Faça upload de uma planilha para visualizar os dados</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Barra de Status -->
        <div class="bg-white rounded-lg shadow p-4 mt-6">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                    <span class="text-gray-600 text-sm" id="status">Pronto para importar planilha</span>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-gray-500 text-sm" id="nomeArquivo">Nenhum arquivo selecionado</span>
                    <button onclick="limparTudo()" class="text-red-500 hover:text-red-700 text-sm flex items-center space-x-1">
                        <i class="fas fa-trash"></i>
                        <span>Limpar</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let lancamentos = [];
        let arquivoAtual = '';

        function mostrarMensagem(mensagem, tipo = 'sucesso') {
            const fundo = tipo === 'sucesso' 
                ? 'linear-gradient(to right, #00b09b, #96c93d)' 
                : 'linear-gradient(to right, #ff5f6d, #ffc371)';
            
            Toastify({
                text: mensagem,
                duration: 3000,
                gravity: "top",
                position: "right",
                style: { background: fundo }
            }).showToast();
        }

        function formatarData(data) {
            if (!data) return '';
            try {
                const texto = data.toString().trim();
                if (texto.includes('/')) {
                    const partes = texto.split('/');
                    if (partes.length === 3) {
                        let [dia, mes, ano] = partes.map(p => p.trim().padStart(2, '0'));
                        if (ano.length === 2) ano = '20' + ano;
                        return `${dia}/${mes}/${ano}`;
                    }
                }
                return texto;
            } catch {
                return data || '';
            }
        }

        function formatarDocumento(doc) {
            if (!doc) return '00000000';
            try {
                return doc.toString().replace(/\D/g, '').padStart(8, '0');
            } catch {
                return '00000000';
            }
        }

        function formatarValor(valor) {
            if (!valor) return '0,00';
            try {
                let texto = valor.toString().trim();
                if (texto.includes(',')) return texto;
                
                let numero = parseFloat(texto.replace(/[^\d,.-]/g, '').replace(',', '.'));
                if (isNaN(numero)) return '0,00';
                
                return numero.toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            } catch {
                return '0,00';
            }
        }

        function processarArquivo(evento) {
            const arquivo = evento.target.files[0];
            if (!arquivo) return;

            arquivoAtual = arquivo.name;
            document.getElementById('nomeArquivo').textContent = arquivoAtual;
            document.getElementById('status').textContent = 'Processando arquivo...';

            const leitor = new FileReader();
            leitor.onload = function(e) {
                try {
                    const dados = new Uint8Array(e.target.result);
                    const pasta = XLSX.read(dados, { type: 'array' });
                    const primeiraAba = pasta.Sheets[pasta.SheetNames[0]];
                    const dadosJSON = XLSX.utils.sheet_to_json(primeiraAba, { raw: false });

                    if (dadosJSON.length === 0) {
                        mostrarMensagem('Planilha vazia ou sem dados válidos', 'erro');
                        document.getElementById('status').textContent = 'Erro: Planilha vazia';
                        return;
                    }

                    lancamentos = dadosJSON.map((linha, indice) => ({
                        id: Date.now() + indice,
                        data: formatarData(linha['Data'] || linha['data'] || ''),
                        documento: formatarDocumento(linha['Documento'] || linha['documento'] || ''),
                        contaDebito: (linha['Conta Débito'] || linha['contaDebito'] || linha['conta_debito'] || '').toString(),
                        contaCredito: (linha['Conta Crédito'] || linha['contaCredito'] || linha['conta_credito'] || '').toString(),
                        valor: formatarValor(linha['Valor'] || linha['valor'] || ''),
                        hp: (linha['HP'] || linha['hp'] || '').toString(),
                        historico: (linha['Histórico'] || linha['historico'] || '').toString()
                    }));

                    atualizarTabela();
                    document.getElementById('status').textContent = `Pronto - ${lancamentos.length} lançamentos carregados`;
                    mostrarMensagem(`Planilha importada com ${lancamentos.length} lançamentos`, 'sucesso');
                } catch (erro) {
                    mostrarMensagem('Erro ao processar arquivo Excel', 'erro');
                    document.getElementById('status').textContent = 'Erro no processamento';
                }
            };
            leitor.readAsArrayBuffer(arquivo);
        }

        function atualizarTabela() {
            const tabela = document.getElementById('tabelaLancamentos');
            const contador = document.getElementById('contador');
            
            contador.textContent = lancamentos.length;

            if (lancamentos.length === 0) {
                tabela.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center justify-center">
                                <i class="fas fa-inbox text-gray-300 text-4xl mb-3"></i>
                                <p class="text-gray-500 font-medium">Nenhum lançamento importado</p>
                                <p class="text-gray-400 text-sm">Faça upload de uma planilha para visualizar os dados</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';
            lancamentos.forEach(lanc => {
                html += `
                    <tr class="border-t hover:bg-gray-50">
                        <td class="px-4 py-3 text-sm">${lanc.data}</td>
                        <td class="px-4 py-3 text-sm font-mono">${lanc.documento}</td>
                        <td class="px-4 py-3 text-sm">${lanc.contaDebito}</td>
                        <td class="px-4 py-3 text-sm">${lanc.contaCredito}</td>
                        <td class="px-4 py-3 text-sm text-right font-mono text-green-600">${lanc.valor}</td>
                        <td class="px-4 py-3 text-sm text-center">${lanc.hp}</td>
                        <td class="px-4 py-3 text-sm">${lanc.historico}</td>
                    </tr>
                `;
            });
            tabela.innerHTML = html;
        }

        function baixarModelo() {
            const dados = [
                {
                    'Data': '15/01/2024',
                    'Documento': '00000001',
                    'Conta Débito': '1.1.1.01.001',
                    'Conta Crédito': '2.1.1.01.001', 
                    'Valor': '1500,00',
                    'HP': '001',
                    'Histórico': 'Pagamento de fornecedor'
                },
                {
                    'Data': '16/01/2024',
                    'Documento': '00000002',
                    'Conta Débito': '1.1.1.02.001',
                    'Conta Crédito': '2.1.1.02.001', 
                    'Valor': '2500,00',
                    'HP': '002',
                    'Histórico': 'Recebimento de cliente'
                }
            ];

            const planilha = XLSX.utils.json_to_sheet(dados);
            const livro = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(livro, planilha, "Lançamentos");
            
            const larguras = [
                { wch: 12 }, { wch: 10 }, { wch: 15 }, { wch: 15 },
                { wch: 12 }, { wch: 6 }, { wch: 25 }
            ];
            planilha['!cols'] = larguras;

            XLSX.writeFile(livro, "modelo_lancamentos.xlsx");
            mostrarMensagem('Modelo baixado com sucesso!', 'sucesso');
        }

        // GERAR CTBIL - SIMPLIFICADO E CORRIGIDO
        function gerarCTBIL() {
            if (lancamentos.length === 0) {
                mostrarMensagem('Nenhum lançamento para gerar CTBIL', 'erro');
                return;
            }

            try {
                let conteudoCTBIL = '';
                let numero = 1;
                
                lancamentos.forEach(lanc => {
                    const dataCTBIL = lanc.data.split('/').reverse().join('');
                    const numeroFormatado = numero.toString().padStart(8, '0');
                    
                    // CONVERSÃO SIMPLES: manter o valor com ponto decimal
                    let valorString = lanc.valor.toString();
                    
                    // Substituir vírgula por ponto e remover separadores de milhar
                    valorString = valorString.replace(/\./g, '').replace(',', '.');
                    
                    // Manter o valor como está (ex: "1500.75")
                    const valorFormatado = valorString.padStart(14, '0');
                    
                    const historicoFormatado = (lanc.historico || 'Lancamento automatico')
                        .substring(0, 50)
                        .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                        .replace(/[^\w\s]/g, ' ')
                        .padEnd(50, ' ');
                    
                    const contaDebito = (lanc.contaDebito || '').padEnd(17, ' ');
                    const contaCredito = (lanc.contaCredito || '').padEnd(17, ' ');
                    const hp = (lanc.hp || '   ').padEnd(3, ' ');
                    
                    const linha = 
                        dataCTBIL.padStart(8, '0') +
                        numeroFormatado +
                        contaDebito +
                        contaCredito +
                        valorFormatado +
                        hp +
                        historicoFormatado +
                        '00' + // Filial débito
                        '00';  // Filial crédito
                    
                    conteudoCTBIL += linha + '\r\n';
                    numero++;
                });

                // Download do arquivo
                const blob = new Blob([conteudoCTBIL], { type: 'text/plain;charset=ascii' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'CTBIL001.TXT';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                mostrarMensagem('Arquivo CTBIL gerado com sucesso!', 'sucesso');
            } catch (erro) {
                mostrarMensagem('Erro ao gerar CTBIL: ' + erro.message, 'erro');
            }
        }

        function limparTudo() {
            lancamentos = [];
            arquivoAtual = '';
            document.getElementById('fileInput').value = '';
            document.getElementById('nomeArquivo').textContent = 'Nenhum arquivo selecionado';
            document.getElementById('status').textContent = 'Pronto para importar planilha';
            atualizarTabela();
            mostrarMensagem('Dados limpos com sucesso', 'sucesso');
        }

        document.getElementById('campoBusca').addEventListener('input', function(e) {
            const termo = e.target.value.toLowerCase();
            const linhas = document.querySelectorAll('#tabelaLancamentos tr');
            
            linhas.forEach(linha => {
                if (linha.cells.length > 1) {
                    const texto = linha.textContent.toLowerCase();
                    linha.style.display = texto.includes(termo) ? '' : 'none';
                }
            });
        });

        document.addEventListener('DOMContentLoaded', function() {
            atualizarTabela();
        });
    </script>
</body>
</html>