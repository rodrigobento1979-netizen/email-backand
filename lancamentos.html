<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema CTBIL</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.12.0/toastify.min.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --success: #06d6a0;
            --warning: #ffd166;
            --danger: #ef476f;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --gray-light: #e9ecef;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fb;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header Styles */
        header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-radius: 12px;
            padding: 25px 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 20px rgba(67, 97, 238, 0.15);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-icon {
            background: rgba(255, 255, 255, 0.2);
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .logo-text h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .logo-text p {
            opacity: 0.9;
            font-size: 16px;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 15px;
        }
        
        .btn-primary {
            background-color: white;
            color: var(--primary);
        }
        
        .btn-primary:hover {
            background-color: var(--light);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        /* Card Styles */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
            overflow: hidden;
        }
        
        .card-header {
            padding: 20px 25px;
            border-bottom: 1px solid var(--gray-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-header h2 {
            font-size: 20px;
            font-weight: 600;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-body {
            padding: 25px;
        }
        
        /* Upload Area */
        .upload-area {
            text-align: center;
            padding: 40px 20px;
        }
        
        .upload-icon {
            width: 80px;
            height: 80px;
            background: rgba(67, 97, 238, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            color: var(--primary);
            font-size: 32px;
        }
        
        .upload-area h3 {
            font-size: 22px;
            margin-bottom: 10px;
            color: var(--dark);
        }
        
        .upload-area p {
            color: var(--gray);
            margin-bottom: 25px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .file-input-container {
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 40px 20px;
            margin-bottom: 25px;
            transition: all 0.3s ease;
            background: #fafbfc;
        }
        
        .file-input-container:hover {
            border-color: var(--primary);
            background: rgba(67, 97, 238, 0.03);
        }
        
        .file-input-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            cursor: pointer;
        }
        
        .file-input-label i {
            font-size: 48px;
            color: #9ca3af;
        }
        
        .file-input-label span {
            color: var(--primary);
            font-weight: 600;
            font-size: 18px;
        }
        
        .file-input-label p {
            color: var(--gray);
            margin: 0;
        }
        
        .file-input {
            display: none;
        }
        
        .info-box {
            background: rgba(67, 97, 238, 0.05);
            border-radius: 8px;
            padding: 15px 20px;
            border-left: 4px solid var(--primary);
        }
        
        .info-box p {
            margin: 0;
            color: var(--dark);
            font-size: 14px;
        }
        
        .info-box strong {
            color: var(--primary);
        }
        
        /* Table Styles */
        .table-container {
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: #f8f9fa;
            position: sticky;
            top: 0;
        }
        
        th {
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            color: var(--dark);
            border-bottom: 1px solid var(--gray-light);
            font-size: 14px;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid var(--gray-light);
            font-size: 14px;
        }
        
        tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            color: #d1d5db;
        }
        
        .empty-state p {
            margin-bottom: 5px;
        }
        
        /* Search and Actions */
        .search-box {
            position: relative;
            margin-bottom: 20px;
        }
        
        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 15px 12px 45px;
            border: 1px solid var(--gray-light);
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s ease;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }
        
        .card-footer {
            padding: 20px 25px;
            border-top: 1px solid var(--gray-light);
            display: flex;
            justify-content: flex-end;
        }
        
        .btn-action {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 12px 30px;
            border-radius: 8px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.3);
        }
        
        .counter {
            background: rgba(67, 97, 238, 0.1);
            color: var(--primary);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .logo {
                justify-content: center;
            }
            
            .card-body {
                padding: 15px;
            }
            
            th, td {
                padding: 10px 8px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-file-export"></i>
                    </div>
                    <div class="logo-text">
                        <h1>Sistema CTBIL</h1>
                        <p>Importação e geração de arquivo CTBIL</p>
                    </div>
                </div>
                <button class="btn btn-primary" id="download-template">
                    <i class="fas fa-file-excel"></i>
                    Baixar Modelo
                </button>
            </div>
        </header>

        <div class="card">
            <div class="card-body">
                <div class="upload-area">
                    <div class="upload-icon">
                        <i class="fas fa-file-excel"></i>
                    </div>
                    <h3>Importar Planilha Excel</h3>
                    <p>Faça upload da sua planilha para processar os lançamentos e gerar o arquivo CTBIL</p>
                    
                    <div class="file-input-container">
                        <label class="file-input-label" for="file-upload">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <span>Clique para fazer upload</span>
                            <p>ou arraste o arquivo</p>
                            <p class="small">Formatos suportados: .xlsx, .xls</p>
                        </label>
                        <input type="file" id="file-upload" class="file-input" accept=".xlsx,.xls">
                    </div>
                    
                    <div class="info-box">
                        <p>Certifique-se de que a planilha contém as colunas: <strong>Data, Documento, Conta Débito, Conta Crédito, Valor, HP, Histórico</strong></p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h2>
                    <i class="fas fa-list"></i>
                    Lançamentos Importados
                </h2>
                <div class="counter" id="lancamentos-count">0</div>
            </div>
            
            <div class="card-body">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="search-input" placeholder="Buscar lançamentos...">
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Documento</th>
                                <th>Conta Débito</th>
                                <th>Conta Crédito</th>
                                <th>Valor</th>
                                <th>HP</th>
                                <th>Histórico</th>
                            </tr>
                        </thead>
                        <tbody id="lancamentos-table">
                            <tr>
                                <td colspan="7">
                                    <div class="empty-state">
                                        <i class="fas fa-inbox"></i>
                                        <p>Nenhum lançamento importado</p>
                                        <p>Faça upload de uma planilha para visualizar os dados</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="card-footer">
                <button class="btn-action" id="generate-ctbil">
                    <i class="fas fa-file-export"></i>
                    Gerar CTBIL
                </button>
            </div>
        </div>
    </div>

    <script>
        // Elementos DOM
        const fileUpload = document.getElementById('file-upload');
        const lancamentosTable = document.getElementById('lancamentos-table');
        const lancamentosCount = document.getElementById('lancamentos-count');
        const downloadTemplateBtn = document.getElementById('download-template');
        const generateCtbilBtn = document.getElementById('generate-ctbil');
        const searchInput = document.getElementById('search-input');
        
        // Dados
        let lancamentos = [];
        
        // Função para mostrar notificações
        function showToast(message, type = 'success') {
            const background = type === 'success' 
                ? 'linear-gradient(to right, #00b09b, #96c93d)' 
                : 'linear-gradient(to right, #ff5f6d, #ffc371)';
            
            Toastify({
                text: message,
                duration: 3000,
                gravity: "top",
                position: "right",
                style: {
                    background: background,
                    borderRadius: "8px",
                    fontWeight: "500"
                }
            }).showToast();
        }
        
        // Função para formatar data
        function formatarData(dataString) {
            if (!dataString) return '';
            try {
                const strData = dataString.toString().trim();
                
                if (strData.includes('/')) {
                    const partes = strData.split('/');
                    if (partes.length === 3) {
                        let [dia, mes, ano] = partes.map(p => p.trim().padStart(2, '0'));
                        
                        if (ano.length === 2) {
                            ano = '20' + ano;
                        }
                        
                        return `${dia}/${mes}/${ano}`;
                    }
                }
                
                return strData;
            } catch (error) {
                return dataString?.toString() || '';
            }
        }
        
        // Função para formatar documento
        function formatarDocumento(documento) {
            if (!documento) return '00000000';
            try {
                const apenasNumeros = documento.toString().replace(/\D/g, '');
                return apenasNumeros.padStart(8, '0');
            } catch (error) {
                return '00000000';
            }
        }
        
        // Função para formatar valor
        function formatarValorExibicao(valorStr) {
            if (!valorStr) return '0,00';
            try {
                let valor = valorStr.toString().trim();
                if (valor.includes(',')) return valor;
                
                let numero = parseFloat(valor.replace(/[^\d,.-]/g, '').replace(',', '.'));
                if (isNaN(numero)) return '0,00';
                
                return numero.toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
            } catch (error) {
                return '0,00';
            }
        }
        
        // Função para atualizar a tabela
        function atualizarTabela() {
            lancamentosCount.textContent = lancamentos.length;
            
            if (lancamentos.length === 0) {
                lancamentosTable.innerHTML = `
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <i class="fas fa-inbox"></i>
                                <p>Nenhum lançamento importado</p>
                                <p>Faça upload de uma planilha para visualizar os dados</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            lancamentos.forEach(lancamento => {
                html += `
                    <tr>
                        <td>${lancamento.data}</td>
                        <td>${lancamento.documento}</td>
                        <td>${lancamento.contaDebito}</td>
                        <td>${lancamento.contaCredito}</td>
                        <td>R$ ${lancamento.valor}</td>
                        <td>${lancamento.hp}</td>
                        <td>${lancamento.historico}</td>
                    </tr>
                `;
            });
            
            lancamentosTable.innerHTML = html;
        }
        
        // Função para importar planilha
        function importarPlanilha(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { raw: false });
                    
                    if (jsonData.length === 0) {
                        showToast('A planilha está vazia ou não contém dados válidos', 'error');
                        return;
                    }
                    
                    lancamentos = jsonData.map((row, index) => {
                        let dataRaw = row['Data'] || row['data'] || '';
                        let dataFormatada = formatarData(dataRaw.toString());
                        
                        return {
                            id: Date.now() + index,
                            data: dataFormatada,
                            documento: formatarDocumento(row['Documento'] || row['documento'] || ''),
                            contaDebito: (row['Conta Débito'] || row['contaDebito'] || row['conta_debito'] || '').toString(),
                            contaCredito: (row['Conta Crédito'] || row['contaCredito'] || row['conta_credito'] || '').toString(),
                            valor: formatarValorExibicao(row['Valor'] || row['valor'] || ''),
                            hp: (row['HP'] || row['hp'] || '').toString(),
                            historico: (row['Histórico'] || row['historico'] || '').toString()
                        };
                    });
                    
                    atualizarTabela();
                    showToast(`Planilha importada com ${lancamentos.length} lançamentos`, 'success');
                } catch (error) {
                    showToast('Erro ao importar arquivo Excel. Verifique o formato.', 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        // Função para gerar modelo
        function gerarModeloPlanilha() {
            const dados = [
                {
                    'Data': '15/01/2024',
                    'Documento': '00000001',
                    'Conta Débito': '1.1.1.01.001',
                    'Conta Crédito': '2.1.1.01.001', 
                    'Valor': '1500,00',
                    'HP': '001',
                    'Histórico': 'Pagamento de fornecedor'
                },
                {
                    'Data': '16/01/2024',
                    'Documento': '00000002',
                    'Conta Débito': '1.1.1.02.001',
                    'Conta Crédito': '2.1.1.02.001', 
                    'Valor': '2500,00',
                    'HP': '002',
                    'Histórico': 'Recebimento de cliente'
                }
            ];
            
            const worksheet = XLSX.utils.json_to_sheet(dados);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Lançamentos");
            
            const colWidths = [
                { wch: 12 }, { wch: 10 }, { wch: 15 }, { wch: 15 },
                { wch: 12 }, { wch: 6 }, { wch: 25 }
            ];
            worksheet['!cols'] = colWidths;
            
            XLSX.writeFile(workbook, "modelo_lancamentos.xlsx");
            showToast('Modelo de planilha baixado com sucesso!', 'success');
        }
        
        // Função para gerar CTBIL
        function gerarCTBIL() {
            if (lancamentos.length === 0) {
                showToast('Nenhum lançamento para gerar CTBIL', 'error');
                return;
            }
            
            showToast('Funcionalidade de geração de CTBIL será implementada em breve!', 'success');
        }
        
        // Event Listeners
        fileUpload.addEventListener('change', importarPlanilha);
        downloadTemplateBtn.addEventListener('click', gerarModeloPlanilha);
        generateCtbilBtn.addEventListener('click', gerarCTBIL);
        
        // Inicialização
        document.addEventListener('DOMContentLoaded', function() {
            atualizarTabela();
        });
    </script>
</body>
</html>