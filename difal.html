<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CalcDIFAL - Sistema de C√°lculo de Diferencial de Al√≠quota</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Adicionando jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(2, 132, 199, 0.3);
        }

        .btn-calculate {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            transition: all 0.3s ease;
        }
        
        .btn-calculate:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
        }

        .btn-pdf {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            transition: all 0.3s ease;
        }
        
        .btn-pdf:hover {
            background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(185, 28, 28, 0.3);
        }

        .btn-rates {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            transition: all 0.3s ease;
        }
        
        .btn-rates:hover {
            background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
        }
        
        .sidebar-item {
            transition: all 0.2s ease;
        }
        
        .sidebar-item:hover {
            background-color: #f8fafc;
            border-left: 3px solid #0ea5e9;
        }
        
        .sidebar-item.active {
            background-color: #f1f5f9;
            border-left: 3px solid #0ea5e9;
            color: #0ea5e9;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-overlay {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        .compact-input {
            padding-top: 0.5rem !important;
            padding-bottom: 0.5rem !important;
        }
        
        .compact-button {
            padding-top: 0.5rem !important;
            padding-bottom: 0.5rem !important;
        }
        
        .custom-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 #f1f5f9;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .calculation-step {
            background: #f8fafc;
            border-left: 4px solid #0ea5e9;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0 0.5rem 0.5rem 0;
        }

        .result-card {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
        }

        .result-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 0.5rem 0;
        }

        .tax-info {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 1rem;
            border-radius: 0 0.5rem 0.5rem 0;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #0ea5e9;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Novos estilos para layout fixo */
        .calculation-header {
            position: sticky;
            top: 0;
            background: white;
            z-index: 40;
            border-bottom: 1px solid #e5e7eb;
            margin: 0 -1rem;
            padding: 1rem;
        }

        .calculation-content {
            max-height: calc(100vh - 300px);
            overflow-y: auto;
        }

        .sticky-results {
            position: sticky;
            top: 0;
            background: white;
            z-index: 30;
            border-bottom: 1px solid #e5e7eb;
            margin: 0 -1rem;
            padding: 1rem;
        }

        /* Estilos para a tabela de al√≠quotas */
        .rates-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .rates-table th {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: white;
            font-weight: 600;
            padding: 0.75rem;
            text-align: left;
        }
        
        .rates-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .rates-table tr:hover {
            background-color: #f8fafc;
        }
        
        .state-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            background: #f1f5f9;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
        }
    </style>
</head>
<body class="min-h-screen p-3">
    <div id="app" class="max-w-7xl mx-auto">
        <div class="text-center py-20">
            <div class="bg-white rounded-2xl p-8 inline-block">
                <i class="fas fa-spinner fa-spin text-3xl text-blue-600 mb-4"></i>
                <p class="text-gray-600">Carregando CalcDIFAL...</p>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo } = React;
        const { jsPDF } = window.jspdf;

        // ‚úÖ Dados de al√≠quotas interestaduais CORRIGIDOS - TODOS com 12%
        const INTERESTADUAL_RATES = {
            "AC": 12, "AL": 12, "AM": 12, "AP": 12, "BA": 12, "CE": 12, "DF": 12, 
            "ES": 12, "GO": 12, "MA": 12, "MG": 12, "MS": 12, "MT": 12, "PA": 12, 
            "PB": 12, "PE": 12, "PI": 12, "PR": 12, "RJ": 12, "RN": 12, "RO": 12, 
            "RR": 12, "RS": 12, "SC": 12, "SE": 12, "SP": 12, "TO": 12
        };

        // Dados de al√≠quotas internas por estado
        const INTERNAL_RATES = {
            "AC": 17, "AL": 18, "AM": 18, "AP": 18, "BA": 18, "CE": 18, "DF": 18, 
            "ES": 17, "GO": 17, "MA": 18, "MG": 18, "MS": 17, "MT": 17, "PA": 17, 
            "PB": 18, "PE": 18, "PI": 18, "PR": 18, "RJ": 20, "RN": 18, "RO": 17.5, 
            "RR": 17, "RS": 18, "SC": 17, "SE": 18, "SP": 18, "TO": 18
        };

        // Estados brasileiros
        const BRAZILIAN_STATES = [
            { value: "AC", label: "Acre" },
            { value: "AL", label: "Alagoas" },
            { value: "AP", label: "Amap√°" },
            { value: "AM", label: "Amazonas" },
            { value: "BA", label: "Bahia" },
            { value: "CE", label: "Cear√°" },
            { value: "DF", label: "Distrito Federal" },
            { value: "ES", label: "Esp√≠rito Santo" },
            { value: "GO", label: "Goi√°s" },
            { value: "MA", label: "Maranh√£o" },
            { value: "MT", label: "Mato Grosso" },
            { value: "MS", label: "Mato Grosso do Sul" },
            { value: "MG", label: "Minas Gerais" },
            { value: "PA", label: "Par√°" },
            { value: "PB", label: "Para√≠ba" },
            { value: "PR", label: "Paran√°" },
            { value: "PE", label: "Pernambuco" },
            { value: "PI", label: "Piau√≠" },
            { value: "RJ", label: "Rio de Janeiro" },
            { value: "RN", label: "Rio Grande do Norte" },
            { value: "RS", label: "Rio Grande do Sul" },
            { value: "RO", label: "Rond√¥nia" },
            { value: "RR", label: "Roraima" },
            { value: "SC", label: "Santa Catarina" },
            { value: "SP", label: "S√£o Paulo" },
            { value: "SE", label: "Sergipe" },
            { value: "TO", label: "Tocantins" }
        ];

        // CFOPs completos para opera√ß√µes interestaduais (entrada e sa√≠da)
        const CFOP_OPTIONS = [
            // CFOPs de ENTRADA (Opera√ß√µes interestaduais)
            { value: "1101", label: "1101 - Compra para industrializa√ß√£o", type: "entrada" },
            { value: "1102", label: "1102 - Compra para comercializa√ß√£o", type: "entrada" },
            { value: "1251", label: "1251 - Compra para uso/consumo", type: "entrada" },
            { value: "1401", label: "1401 - Compra para industrializa√ß√£o de bem para ativo imobilizado", type: "entrada" },
            { value: "1403", label: "1403 - Compra para comercializa√ß√£o de bem para ativo imobilizado", type: "entrada" },
            { value: "1551", label: "1551 - Transfer√™ncia para industrializa√ß√£o", type: "entrada" },
            { value: "1552", label: "1552 - Transfer√™ncia para comercializa√ß√£o", type: "entrada" },
            { value: "1556", label: "1556 - Transfer√™ncia para uso/consumo", type: "entrada" },
            { value: "2101", label: "2101 - Compra para industrializa√ß√£o", type: "entrada" },
            { value: "2102", label: "2102 - Compra para comercializa√ß√£o", type: "entrada" },
            { value: "2251", label: "2251 - Compra para uso/consumo", type: "entrada" },
            { value: "2401", label: "2401 - Compra para industrializa√ß√£o de bem para ativo imobilizado", type: "entrada" },
            { value: "2403", label: "2403 - Compra para comercializa√ß√£o de bem para ativo imobilizado", type: "entrada" },
            { value: "2551", label: "2551 - Transfer√™ncia para industrializa√ß√£o", type: "entrada" },
            { value: "2552", label: "2552 - Transfer√™ncia para comercializa√ß√£o", type: "entrada" },
            { value: "2556", label: "2556 - Transfer√™ncia para uso/consumo", type: "entrada" },
            { value: "3101", label: "3101 - Compra para industrializa√ß√£o", type: "entrada" },
            { value: "3102", label: "3102 - Compra para comercializa√ß√£o", type: "entrada" },
            { value: "3126", label: "3126 - Compra para utiliza√ß√£o na presta√ß√£o de servi√ßo", type: "entrada" },
            { value: "3127", label: "3127 - Compra para industrializa√ß√£o sob regime de drawback", type: "entrada" },
            { value: "3251", label: "3251 - Compra para uso/consumo", type: "entrada" },
            { value: "3401", label: "3401 - Compra para industrializa√ß√£o de bem para ativo imobilizado", type: "entrada" },
            { value: "3403", label: "3403 - Compra para comercializa√ß√£o de bem para ativo imobilizado", type: "entrada" },
            { value: "3551", label: "3551 - Transfer√™ncia para industrializa√ß√£o", type: "entrada" },
            { value: "3552", label: "3552 - Transfer√™ncia para comercializa√ß√£o", type: "entrada" },
            { value: "3556", label: "3556 - Transfer√™ncia para uso/consumo", type: "entrada" },
            
            // CFOPs de SA√çDA (Opera√ß√µes interestaduais) - mantidos para completude
            { value: "5101", label: "5101 - Venda de produ√ß√£o do estabelecimento", type: "saida" },
            { value: "5102", label: "5102 - Venda de mercadoria adquirida ou recebida de terceiros", type: "saida" },
            { value: "6101", label: "6101 - Venda de produ√ß√£o do estabelecimento", type: "saida" },
            { value: "6102", label: "6102 - Venda de mercadoria adquirida ou recebida de terceiros", type: "saida" },
            { value: "7101", label: "7101 - Venda de produ√ß√£o do estabelecimento", type: "saida" },
            { value: "7102", label: "7102 - Venda de mercadoria adquirida ou recebida de terceiros", type: "saida" }
        ];

        const ToastManager = {
            show: (message, type = 'info', duration = 5000) => {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                const bgColors = {
                    success: 'bg-green-500',
                    error: 'bg-red-500',
                    warning: 'bg-yellow-500',
                    info: 'bg-blue-500'
                };
                
                toast.className = `toast ${bgColors[type]} text-white px-6 py-3 rounded-lg shadow-lg mb-2 flex items-center justify-between min-w-80`;
                toast.innerHTML = `
                    <div class="flex items-center gap-2">
                        <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'}"></i>
                        <span>${message}</span>
                    </div>
                    <button onclick="this.parentElement.remove()" class="text-white hover:text-gray-200 ml-4">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                container.appendChild(toast);
                
                setTimeout(() => {
                    if (toast.parentElement) {
                        toast.remove();
                    }
                }, duration);
            }
        };

        // Modal de Consulta de Al√≠quotas
        function RatesModal({ isOpen, onClose }) {
            if (!isOpen) return null;

            const regions = {
                "Norte": ["AC", "AM", "AP", "PA", "RO", "RR", "TO"],
                "Nordeste": ["AL", "BA", "CE", "MA", "PB", "PE", "PI", "RN", "SE"],
                "Centro-Oeste": ["DF", "GO", "MT", "MS"],
                "Sudeste": ["ES", "MG", "RJ", "SP"],
                "Sul": ["PR", "RS", "SC"]
            };

            return ReactDOM.createPortal(
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay">
                    <div className="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
                        <div className="flex justify-between items-center p-6 border-b border-gray-200">
                            <div>
                                <h2 className="text-xl font-bold text-gray-800">Tabela de Al√≠quotas Interestaduais 2024</h2>
                                <p className="text-gray-600 text-sm mt-1">Al√≠quotas aplic√°veis para opera√ß√µes entre contribuintes</p>
                            </div>
                            <button
                                onClick={onClose}
                                className="text-gray-400 hover:text-gray-600 transition text-lg"
                            >
                                <i className="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div className="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
                            {/* Informa√ß√£o Importante */}
                            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                                <div className="flex items-start gap-3">
                                    <i className="fas fa-info-circle text-blue-600 mt-1"></i>
                                    <div>
                                        <h3 className="font-semibold text-blue-800 text-sm mb-1">
                                            Al√≠quota √önica de 12% para Todos os Estados
                                        </h3>
                                        <p className="text-blue-700 text-sm">
                                            Desde 2019, as opera√ß√µes interestaduais entre contribuintes possuem al√≠quota √∫nica de 12%, 
                                            independentemente dos estados de origem e destino, conforme Conv√™nio ICMS 142/2018.
                                        </p>
                                    </div>
                                </div>
                            </div>

                            {/* Tabela de Al√≠quotas Interestaduais */}
                            <div className="mb-8">
                                <h3 className="text-lg font-semibold text-gray-800 mb-4">Al√≠quotas Interestaduais</h3>
                                <div className="overflow-hidden rounded-lg border border-gray-200">
                                    <table className="rates-table w-full">
                                        <thead>
                                            <tr>
                                                <th>Regi√£o</th>
                                                <th>Estados</th>
                                                <th>Al√≠quota</th>
                                                <th>Observa√ß√£o</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {Object.entries(regions).map(([region, states]) => (
                                                <tr key={region}>
                                                    <td className="font-semibold text-gray-800">{region}</td>
                                                    <td>
                                                        <div className="flex flex-wrap gap-1">
                                                            {states.map(stateCode => (
                                                                <span key={stateCode} className="state-badge">
                                                                    {stateCode} - {BRAZILIAN_STATES.find(s => s.value === stateCode)?.label}
                                                                </span>
                                                            ))}
                                                        </div>
                                                    </td>
                                                    <td className="font-bold text-green-600">12%</td>
                                                    <td className="text-sm text-gray-600">
                                                        {region === "Sudeste" ? "Inclui MG e SP com 12%" : "Al√≠quota padr√£o"}
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            {/* Tabela de Al√≠quotas Internas */}
                            <div>
                                <h3 className="text-lg font-semibold text-gray-800 mb-4">Al√≠quotas Internas por Estado</h3>
                                <div className="overflow-hidden rounded-lg border border-gray-200">
                                    <table className="rates-table w-full">
                                        <thead>
                                            <tr>
                                                <th>Estado</th>
                                                <th>Al√≠quota Interna</th>
                                                <th>C√≥digo</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {BRAZILIAN_STATES.map(state => (
                                                <tr key={state.value}>
                                                    <td className="font-medium text-gray-800">{state.label}</td>
                                                    <td className="font-bold text-blue-600">{INTERNAL_RATES[state.value]}%</td>
                                                    <td className="text-sm text-gray-600">{state.value}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            {/* Legenda e Observa√ß√µes */}
                            <div className="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                    <h4 className="font-semibold text-yellow-800 text-sm mb-2">üìù Observa√ß√µes Importantes</h4>
                                    <ul className="text-yellow-700 text-sm space-y-1">
                                        <li>‚Ä¢ Al√≠quota interestadual: 12% para todos os estados</li>
                                        <li>‚Ä¢ Al√≠quota interna: varia conforme o estado de destino</li>
                                        <li>‚Ä¢ DIFAL = (Al√≠quota Interna - 12%) √ó Base de C√°lculo</li>
                                    </ul>
                                </div>
                                <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                                    <h4 className="font-semibold text-green-800 text-sm mb-2">‚ÑπÔ∏è Como Calcular</h4>
                                    <ul className="text-green-700 text-sm space-y-1">
                                        <li>‚Ä¢ Base de c√°lculo: Valor da opera√ß√£o</li>
                                        <li>‚Ä¢ DIFAL: Diferen√ßa entre al√≠quotas</li>
                                        <li>‚Ä¢ FCP: Adicional sobre a base de c√°lculo</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div className="flex justify-end p-4 border-t border-gray-200 bg-gray-50">
                            <button
                                onClick={onClose}
                                className="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg font-semibold transition flex items-center gap-2"
                            >
                                <i className="fas fa-times"></i>
                                Fechar
                            </button>
                        </div>
                    </div>
                </div>,
                document.body
            );
        }

        // Fun√ß√£o para exportar PDF
        const exportToPDF = (calculationResult, calculationSteps) => {
            if (!calculationResult) {
                ToastManager.show('Nenhum c√°lculo para exportar', 'warning');
                return;
            }

            try {
                const doc = new jsPDF();
                
                // Configura√ß√µes iniciais
                const pageWidth = doc.internal.pageSize.getWidth();
                let yPosition = 15;
                
                // Cores
                const primaryColor = [41, 128, 185];
                const successColor = [39, 174, 96];
                const warningColor = [243, 156, 18];
                
                // Cabe√ßalho
                doc.setFillColor(...primaryColor);
                doc.rect(0, 0, pageWidth, 25, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(16);
                doc.setFont('helvetica', 'bold');
                doc.text('RELAT√ìRIO DE C√ÅLCULO DIFAL', pageWidth / 2, 15, { align: 'center' });
                
                doc.setFontSize(10);
                doc.text('CalcDIFAL - Sistema de C√°lculo de Diferencial de Al√≠quota', pageWidth / 2, 22, { align: 'center' });
                
                yPosition = 35;
                
                // Informa√ß√µes da opera√ß√£o
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('INFORMA√á√ïES DA OPERA√á√ÉO', 14, yPosition);
                
                yPosition += 8;
                doc.setFontSize(9);
                doc.setFont('helvetica', 'normal');
                
                const originStateLabel = BRAZILIAN_STATES.find(s => s.value === calculationResult.originState)?.label;
                const destinationStateLabel = BRAZILIAN_STATES.find(s => s.value === calculationResult.destinationState)?.label;
                
                const operationInfo = [
                    [`Data do C√°lculo:`, new Date(calculationResult.calculationDate).toLocaleString('pt-BR')],
                    [`Origem:`, `${originStateLabel} (${calculationResult.originState})`],
                    [`Destino:`, `${destinationStateLabel} (${calculationResult.destinationState})`],
                    [`Valor da Opera√ß√£o:`, `R$ ${calculationResult.totalValue.toFixed(2)}`],
                    [`CFOP:`, calculationResult.cfop],
                    [`M√©todo de C√°lculo:`, calculationResult.calculationType === 'por_dentro' ? 'Por Dentro' : 'Por Fora'],
                    [`Al√≠quota Interestadual:`, `${(calculationResult.interstateRate * 100).toFixed(2)}%`],
                    [`Al√≠quota Interna:`, `${(calculationResult.internalRate * 100).toFixed(2)}%`],
                    [`Al√≠quota FCP:`, `${(calculationResult.fcpRate * 100).toFixed(2)}%`]
                ];
                
                operationInfo.forEach(([label, value]) => {
                    doc.setFont('helvetica', 'bold');
                    doc.text(label, 14, yPosition);
                    doc.setFont('helvetica', 'normal');
                    doc.text(value, 70, yPosition);
                    yPosition += 5;
                });
                
                yPosition += 5;
                
                // Resultados
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(12);
                doc.text('RESULTADOS DO C√ÅLCULO', 14, yPosition);
                
                yPosition += 8;
                doc.setFontSize(9);
                
                const results = [
                    ['Base de C√°lculo:', `R$ ${calculationResult.icmsBase.toFixed(2)}`],
                    ['ICMS Interestadual:', `R$ ${calculationResult.interstateIcms.toFixed(2)}`],
                    ['ICMS Interno:', `R$ ${calculationResult.internalIcms.toFixed(2)}`],
                    ['Fundo de Combate √† Pobreza (FCP):', `R$ ${calculationResult.fcpValue.toFixed(2)}`],
                    ['DIFAL (Diferencial de Al√≠quota):', `R$ ${calculationResult.difal.toFixed(2)}`]
                ];
                
                results.forEach(([label, value]) => {
                    doc.setFont('helvetica', 'bold');
                    doc.text(label, 14, yPosition);
                    doc.setFont('helvetica', 'normal');
                    doc.text(value, 70, yPosition);
                    yPosition += 5;
                });
                
                // Total a Recolher em destaque
                yPosition += 3;
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(11);
                doc.setTextColor(...successColor);
                doc.text('TOTAL A RECOLHER:', 14, yPosition);
                doc.text(`R$ ${calculationResult.totalToPay.toFixed(2)}`, 70, yPosition);
                
                yPosition += 10;
                doc.setTextColor(0, 0, 0);
                
                // Detalhamento do C√°lculo
                if (calculationSteps && calculationSteps.length > 0) {
                    // Verificar se precisa de nova p√°gina
                    if (yPosition > 240) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(12);
                    doc.text('DETALHAMENTO DO C√ÅLCULO', 14, yPosition);
                    yPosition += 8;
                    
                    calculationSteps.forEach((step, index) => {
                        // Verificar se precisa de nova p√°gina
                        if (yPosition > 270) {
                            doc.addPage();
                            yPosition = 20;
                        }
                        
                        doc.setFontSize(9);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(...primaryColor);
                        doc.text(`${index + 1}. ${step.title}`, 14, yPosition);
                        yPosition += 4;
                        
                        doc.setFont('helvetica', 'normal');
                        doc.setTextColor(0, 0, 0);
                        doc.text(step.description, 20, yPosition);
                        yPosition += 4;
                        
                        doc.setFont('helvetica', 'italic');
                        doc.text(step.calculation, 20, yPosition);
                        yPosition += 4;
                        
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(...successColor);
                        doc.text(`Resultado: ${step.result}`, 20, yPosition);
                        yPosition += 8;
                    });
                }
                
                // Rodap√©
                const totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(128, 128, 128);
                    doc.text(
                        `P√°gina ${i} de ${totalPages} ‚Ä¢ Gerado em ${new Date().toLocaleString('pt-BR')} ‚Ä¢ CalcDIFAL`,
                        pageWidth / 2,
                        290,
                        { align: 'center' }
                    );
                }
                
                // Salvar PDF
                const fileName = `DIFAL_${calculationResult.originState}_${calculationResult.destinationState}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                
                ToastManager.show('PDF exportado com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                ToastManager.show('Erro ao exportar PDF', 'error');
            }
        };

        function App() {
            const [currentView, setCurrentView] = useState('calculator');
            const [isLoading, setIsLoading] = useState(true);
            const [showRatesModal, setShowRatesModal] = useState(false);
            
            // Dados do formul√°rio
            const [originState, setOriginState] = useState('');
            const [destinationState, setDestinationState] = useState('');
            const [totalValue, setTotalValue] = useState('');
            const [cfop, setCfop] = useState('');
            const [fcpRate, setFcpRate] = useState('');
            const [calculationType, setCalculationType] = useState('por_dentro'); // 'por_dentro' ou 'por_fora'
            
            // Resultados do c√°lculo
            const [calculationResult, setCalculationResult] = useState(null);
            const [calculationSteps, setCalculationSteps] = useState([]);
            const [calculationHistory, setCalculationHistory] = useState([]);
            
            // Carregar hist√≥rico do localStorage
            useEffect(() => {
                const loadHistory = () => {
                    try {
                        const historyData = localStorage.getItem('difalHistory');
                        if (historyData) {
                            setCalculationHistory(JSON.parse(historyData));
                        }
                    } catch (error) {
                        console.error('Erro ao carregar hist√≥rico:', error);
                    } finally {
                        setIsLoading(false);
                    }
                };
                
                loadHistory();
            }, []);
            
            // Salvar hist√≥rico no localStorage
            const saveHistory = (newHistory) => {
                try {
                    localStorage.setItem('difalHistory', JSON.stringify(newHistory));
                } catch (error) {
                    console.error('Erro ao salvar hist√≥rico:', error);
                }
            };
            
            // Validar dados de entrada
            const validateInputs = () => {
                if (!originState) {
                    ToastManager.show('Selecione o estado de origem', 'warning');
                    return false;
                }
                
                if (!destinationState) {
                    ToastManager.show('Selecione o estado de destino', 'warning');
                    return false;
                }
                
                if (originState === destinationState) {
                    ToastManager.show('Os estados de origem e destino devem ser diferentes', 'warning');
                    return false;
                }
                
                if (!totalValue || parseFloat(totalValue) <= 0) {
                    ToastManager.show('Informe um valor total v√°lido', 'warning');
                    return false;
                }
                
                if (!cfop) {
                    ToastManager.show('Selecione um CFOP', 'warning');
                    return false;
                }
                
                if (!fcpRate || parseFloat(fcpRate) < 0) {
                    ToastManager.show('Informe uma al√≠quota FCP v√°lida', 'warning');
                    return false;
                }
                
                return true;
            };
            
            // Calcular DIFAL - C√ìDIGO CORRIGIDO
            const calculateDifal = () => {
                if (!validateInputs()) return;
                
                const value = parseFloat(totalValue);
                const fcp = parseFloat(fcpRate) / 100;
                
                // Obter al√≠quotas CORRETAS
                const interstateRate = INTERESTADUAL_RATES[originState] / 100;
                const internalRate = INTERNAL_RATES[destinationState] / 100;
                
                let icmsBase, interstateIcms, internalIcms, fcpValue, difal;
                
                if (calculationType === 'por_dentro') {
                    // C√ÅLCULO "POR DENTRO" CORRETO
                    // 1. ICMS de origem (destacado na nota)
                    interstateIcms = value * interstateRate;
                    
                    // 2. Base de c√°lculo ajustada (BC por dentro)
                    icmsBase = value / (1 - internalRate);
                    
                    // 3. ICMS total devido ao destino
                    internalIcms = icmsBase * internalRate;
                    
                    // 4. C√°lculo do DIFAL
                    difal = internalIcms - interstateIcms;
                    
                    // 5. FCP sobre a base ajustada
                    fcpValue = icmsBase * fcp;
                    
                } else {
                    // C√°lculo por fora (base de c√°lculo n√£o inclui o ICMS)
                    icmsBase = value;
                    interstateIcms = icmsBase * interstateRate;
                    internalIcms = icmsBase * internalRate;
                    fcpValue = icmsBase * fcp;
                    difal = internalIcms - interstateIcms;
                }
                
                // Preparar resultado
                const result = {
                    originState,
                    destinationState,
                    totalValue: value,
                    cfop,
                    fcpRate: fcp,
                    interstateRate,
                    internalRate,
                    icmsBase,
                    interstateIcms,
                    internalIcms,
                    fcpValue,
                    difal,
                    totalToPay: difal + fcpValue,
                    calculationType,
                    calculationDate: new Date().toISOString()
                };
                
                // Preparar passos do c√°lculo - ATUALIZADO
                const steps = calculationType === 'por_dentro' ? [
                    {
                        title: "ICMS de Origem (Destacado na Nota)",
                        description: `Valor da Opera√ß√£o √ó Al√≠quota Interestadual`,
                        calculation: `R$ ${value.toFixed(2)} √ó ${(interstateRate * 100).toFixed(2)}%`,
                        result: `R$ ${interstateIcms.toFixed(2)}`
                    },
                    {
                        title: "Base de C√°lculo Ajustada (Por Dentro)",
                        description: `Valor da Opera√ß√£o / (1 - Al√≠quota Interna)`,
                        calculation: `R$ ${value.toFixed(2)} / (1 - ${(internalRate * 100).toFixed(2)}%) = R$ ${value.toFixed(2)} / ${(1 - internalRate).toFixed(4)}`,
                        result: `R$ ${icmsBase.toFixed(2)}`
                    },
                    {
                        title: "ICMS Total Devido ao Destino",
                        description: `Base de C√°lculo Ajustada √ó Al√≠quota Interna`,
                        calculation: `R$ ${icmsBase.toFixed(2)} √ó ${(internalRate * 100).toFixed(2)}%`,
                        result: `R$ ${internalIcms.toFixed(2)}`
                    },
                    {
                        title: "Fundo de Combate √† Pobreza (FCP)",
                        description: `Base de C√°lculo Ajustada √ó Al√≠quota FCP`,
                        calculation: `R$ ${icmsBase.toFixed(2)} √ó ${(fcp * 100).toFixed(2)}%`,
                        result: `R$ ${fcpValue.toFixed(2)}`
                    },
                    {
                        title: "DIFAL (Diferencial de Al√≠quota)",
                        description: `ICMS Total Destino - ICMS Origem`,
                        calculation: `R$ ${internalIcms.toFixed(2)} - R$ ${interstateIcms.toFixed(2)}`,
                        result: `R$ ${difal.toFixed(2)}`
                    },
                    {
                        title: "Total a Recolher",
                        description: `DIFAL + FCP`,
                        calculation: `R$ ${difal.toFixed(2)} + R$ ${fcpValue.toFixed(2)}`,
                        result: `R$ ${(difal + fcpValue).toFixed(2)}`
                    }
                ] : [
                    {
                        title: "Base de C√°lculo do ICMS",
                        description: `Valor da opera√ß√£o (c√°lculo por fora)`,
                        calculation: `R$ ${value.toFixed(2)}`,
                        result: `R$ ${value.toFixed(2)}`
                    },
                    {
                        title: "ICMS Interestadual",
                        description: `Base de C√°lculo √ó Al√≠quota Interestadual`,
                        calculation: `R$ ${value.toFixed(2)} √ó ${(interstateRate * 100).toFixed(2)}%`,
                        result: `R$ ${interstateIcms.toFixed(2)}`
                    },
                    {
                        title: "ICMS Interno",
                        description: `Base de C√°lculo √ó Al√≠quota Interna do Estado de Destino`,
                        calculation: `R$ ${value.toFixed(2)} √ó ${(internalRate * 100).toFixed(2)}%`,
                        result: `R$ ${internalIcms.toFixed(2)}`
                    },
                    {
                        title: "Fundo de Combate √† Pobreza (FCP)",
                        description: `Base de C√°lculo √ó Al√≠quota FCP`,
                        calculation: `R$ ${value.toFixed(2)} √ó ${(fcp * 100).toFixed(2)}%`,
                        result: `R$ ${fcpValue.toFixed(2)}`
                    },
                    {
                        title: "DIFAL (Diferencial de Al√≠quota)",
                        description: `ICMS Interno - ICMS Interestadual`,
                        calculation: `R$ ${internalIcms.toFixed(2)} - R$ ${interstateIcms.toFixed(2)}`,
                        result: `R$ ${difal.toFixed(2)}`
                    },
                    {
                        title: "Total a Recolher",
                        description: `DIFAL + FCP`,
                        calculation: `R$ ${difal.toFixed(2)} + R$ ${fcpValue.toFixed(2)}`,
                        result: `R$ ${(difal + fcpValue).toFixed(2)}`
                    }
                ];
                
                setCalculationResult(result);
                setCalculationSteps(steps);
                
                // Adicionar ao hist√≥rico
                const newHistoryItem = {
                    id: Date.now(),
                    ...result
                };
                
                const updatedHistory = [newHistoryItem, ...calculationHistory.slice(0, 49)]; // Manter apenas os 50 √∫ltimos
                setCalculationHistory(updatedHistory);
                saveHistory(updatedHistory);
                
                ToastManager.show('C√°lculo realizado com sucesso!', 'success');
            };
            
            // Limpar formul√°rio
            const clearForm = () => {
                setOriginState('');
                setDestinationState('');
                setTotalValue('');
                setCfop('');
                setFcpRate('');
                setCalculationResult(null);
                setCalculationSteps([]);
            };
            
            // Limpar hist√≥rico
            const clearHistory = () => {
                setCalculationHistory([]);
                localStorage.removeItem('difalHistory');
                ToastManager.show('Hist√≥rico limpo com sucesso', 'success');
            };
            
            // Exportar hist√≥rico
            const exportHistory = () => {
                const dataStr = JSON.stringify(calculationHistory, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `difal-history-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                setTimeout(() => URL.revokeObjectURL(link.href), 100);
                ToastManager.show('Hist√≥rico exportado com sucesso', 'success');
            };
            
            // Formatar moeda
            const formatCurrency = (value) => {
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(value);
            };
            
            // Formatar porcentagem
            const formatPercentage = (value) => {
                return `${(value * 100).toFixed(2)}%`;
            };
            
            // Obter CFOPs filtrados por tipo
            const getFilteredCfops = (type) => {
                return CFOP_OPTIONS.filter(cfop => cfop.type === type);
            };
            
            if (isLoading) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="bg-white rounded-2xl p-8 text-center">
                            <i className="fas fa-spinner fa-spin text-3xl text-blue-600 mb-4"></i>
                            <p className="text-gray-600">Carregando CalcDIFAL...</p>
                        </div>
                    </div>
                );
            }
            
            return (
                <div className="fade-in">
                    {/* Header */}
                    <div className="bg-white rounded-xl shadow-lg border border-gray-200 mb-6 p-4 card-hover">
                        <div className="flex justify-between items-center">
                            <div className="flex items-center gap-3">
                                <div className="bg-gradient-to-r from-blue-600 to-purple-600 p-2 rounded-lg">
                                    <i className="fas fa-calculator text-xl text-white"></i>
                                </div>
                                <div>
                                    <h1 className="text-lg font-bold text-gray-800">CalcDIFAL</h1>
                                    <p className="text-gray-600 text-xs">Sistema de C√°lculo de Diferencial de Al√≠quota</p>
                                </div>
                            </div>
                            
                            <div className="flex items-center gap-3">
                                <button
                                    onClick={() => setShowRatesModal(true)}
                                    className="btn-rates text-white px-4 py-2 rounded-lg font-semibold text-sm card-hover transition-all duration-300 flex items-center gap-2"
                                >
                                    <i className="fas fa-table"></i>
                                    Consulta Al√≠quota
                                </button>
                                <div className="bg-gray-50 rounded-full p-1 px-3 border border-gray-200">
                                    <div className="flex items-center gap-1">
                                        <i className="fas fa-history text-blue-600 text-sm"></i>
                                        <span className="text-gray-700 font-semibold text-sm">
                                            {calculationHistory.length} c√°lculos
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-4 gap-4">
                        {/* Sidebar */}
                        <div className="lg:col-span-1">
                            <div className="bg-white rounded-xl shadow-lg border border-gray-200 p-3">
                                <nav className="space-y-1">
                                    {[
                                        { id: 'calculator', icon: 'fa-calculator', label: 'Calculadora DIFAL' },
                                        { id: 'history', icon: 'fa-history', label: `Hist√≥rico (${calculationHistory.length})` },
                                        { id: 'info', icon: 'fa-info-circle', label: 'Informa√ß√µes' }
                                    ].map(item => (
                                        <button
                                            key={item.id}
                                            onClick={() => setCurrentView(item.id)}
                                            className={`w-full text-left p-2 rounded-lg transition-all duration-200 sidebar-item text-sm ${
                                                currentView === item.id ? 'active' : 'text-gray-600 hover:text-gray-900'
                                            }`}
                                        >
                                            <div className="flex items-center gap-2">
                                                <i className={`fas ${item.icon} w-4 text-center ${currentView === item.id ? 'text-blue-600' : 'text-gray-400'}`}></i>
                                                <span className="font-medium">{item.label}</span>
                                            </div>
                                        </button>
                                    ))}
                                </nav>

                                {/* Informa√ß√µes sobre DIFAL */}
                                <div className="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                                    <h4 className="font-semibold text-blue-800 text-sm mb-2">Sobre o DIFAL</h4>
                                    <p className="text-blue-700 text-xs">
                                        O Diferencial de Al√≠quota (DIFAL) √© o valor correspondente √† diferen√ßa entre a al√≠quota interna do estado de destino e a al√≠quota interestadual.
                                    </p>
                                </div>
                            </div>
                        </div>

                        {/* Main Content */}
                        <div className="lg:col-span-3">
                            <div className="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden">
                                <div className="p-4">
                                    {/* Calculator View */}
                                    {currentView === 'calculator' && (
                                        <div className="space-y-4 fade-in">
                                            <div className="mb-4">
                                                <h2 className="text-lg font-bold text-gray-800 mb-2">
                                                    Calculadora DIFAL
                                                </h2>
                                                <p className="text-gray-600 text-sm">
                                                    Calcule o diferencial de al√≠quota entre estados brasileiros
                                                </p>
                                            </div>

                                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                                <div className="space-y-4">
                                                    <div>
                                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                            Estado de Origem
                                                        </label>
                                                        <select
                                                            value={originState}
                                                            onChange={(e) => setOriginState(e.target.value)}
                                                            className="w-full px-3 py-2 compact-input bg-white border border-gray-300 rounded-lg text-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm"
                                                        >
                                                            <option value="">Selecione o estado de origem</option>
                                                            {BRAZILIAN_STATES.map(state => (
                                                                <option key={state.value} value={state.value}>
                                                                    {state.label}
                                                                </option>
                                                            ))}
                                                        </select>
                                                        {originState && (
                                                            <p className="text-xs text-gray-500 mt-1">
                                                                Al√≠quota interestadual: {INTERESTADUAL_RATES[originState]}%
                                                            </p>
                                                        )}
                                                    </div>

                                                    <div>
                                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                            Estado de Destino
                                                        </label>
                                                        <select
                                                            value={destinationState}
                                                            onChange={(e) => setDestinationState(e.target.value)}
                                                            className="w-full px-3 py-2 compact-input bg-white border border-gray-300 rounded-lg text-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm"
                                                        >
                                                            <option value="">Selecione o estado de destino</option>
                                                            {BRAZILIAN_STATES.map(state => (
                                                                <option key={state.value} value={state.value}>
                                                                    {state.label}
                                                                </option>
                                                            ))}
                                                        </select>
                                                        {destinationState && (
                                                            <p className="text-xs text-gray-500 mt-1">
                                                                Al√≠quota interna: {INTERNAL_RATES[destinationState]}%
                                                            </p>
                                                        )}
                                                    </div>

                                                    <div>
                                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                            Valor Total da Nota (R$)
                                                        </label>
                                                        <input
                                                            type="number"
                                                            value={totalValue}
                                                            onChange={(e) => setTotalValue(e.target.value)}
                                                            className="w-full px-3 py-2 compact-input bg-white border border-gray-300 rounded-lg text-gray-700 placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm"
                                                            placeholder="0,00"
                                                            step="0.01"
                                                            min="0"
                                                        />
                                                    </div>
                                                </div>

                                                <div className="space-y-4">
                                                    <div>
                                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                            CFOP
                                                        </label>
                                                        <select
                                                            value={cfop}
                                                            onChange={(e) => setCfop(e.target.value)}
                                                            className="w-full px-3 py-2 compact-input bg-white border border-gray-300 rounded-lg text-gray-700 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm"
                                                        >
                                                            <option value="">Selecione o CFOP</option>
                                                            <optgroup label="CFOPs de Entrada">
                                                                {getFilteredCfops('entrada').map(cfop => (
                                                                    <option key={cfop.value} value={cfop.value}>
                                                                        {cfop.label}
                                                                    </option>
                                                                ))}
                                                            </optgroup>
                                                            <optgroup label="CFOPs de Sa√≠da">
                                                                {getFilteredCfops('saida').map(cfop => (
                                                                    <option key={cfop.value} value={cfop.value}>
                                                                        {cfop.label}
                                                                    </option>
                                                                ))}
                                                            </optgroup>
                                                        </select>
                                                    </div>

                                                    <div>
                                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                            Al√≠quota FCP (%)
                                                        </label>
                                                        <input
                                                            type="number"
                                                            value={fcpRate}
                                                            onChange={(e) => setFcpRate(e.target.value)}
                                                            className="w-full px-3 py-2 compact-input bg-white border border-gray-300 rounded-lg text-gray-700 placeholder-gray-400 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition text-sm"
                                                            placeholder="0,00"
                                                            step="0.01"
                                                            min="0"
                                                            max="100"
                                                        />
                                                        <p className="text-xs text-gray-500 mt-1">
                                                            Fundo de Combate √† Pobreza
                                                        </p>
                                                    </div>

                                                    <div>
                                                        <label className="block text-sm font-semibold text-gray-700 mb-2">
                                                            Tipo de C√°lculo
                                                        </label>
                                                        <div className="flex items-center gap-3">
                                                            <label className="flex items-center gap-2 cursor-pointer">
                                                                <input
                                                                    type="radio"
                                                                    value="por_dentro"
                                                                    checked={calculationType === 'por_dentro'}
                                                                    onChange={(e) => setCalculationType(e.target.value)}
                                                                    className="text-blue-600 focus:ring-blue-500"
                                                                />
                                                                <span className="text-sm text-gray-700">Por Dentro</span>
                                                            </label>
                                                            <label className="flex items-center gap-2 cursor-pointer">
                                                                <input
                                                                    type="radio"
                                                                    value="por_fora"
                                                                    checked={calculationType === 'por_fora'}
                                                                    onChange={(e) => setCalculationType(e.target.value)}
                                                                    className="text-blue-600 focus:ring-blue-500"
                                                                />
                                                                <span className="text-sm text-gray-700">Por Fora</span>
                                                            </label>
                                                        </div>
                                                        <p className="text-xs text-gray-500 mt-1">
                                                            {calculationType === 'por_dentro' 
                                                                ? 'Base de c√°lculo ajustada inclui o ICMS (m√©todo mais comum)' 
                                                                : 'Base de c√°lculo n√£o inclui o ICMS'}
                                                        </p>
                                                    </div>

                                                    <div className="flex gap-3 mt-6">
                                                        <button
                                                            onClick={calculateDifal}
                                                            className="flex-1 btn-calculate text-white py-2.5 rounded-lg font-semibold text-sm card-hover transition-all duration-300 flex items-center justify-center gap-2"
                                                        >
                                                            <i className="fas fa-calculator"></i>
                                                            Calcular DIFAL
                                                        </button>
                                                        
                                                        <button
                                                            onClick={clearForm}
                                                            className="flex-1 bg-gray-200 text-gray-700 py-2.5 rounded-lg font-semibold text-sm card-hover transition-all duration-300 flex items-center justify-center gap-2"
                                                        >
                                                            <i className="fas fa-eraser"></i>
                                                            Limpar
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Resultado do C√°lculo */}
                                            {calculationResult && (
                                                <div className="mt-6 fade-in">
                                                    {/* Cabe√ßalho Fixo */}
                                                    <div className="calculation-header">
                                                        <div className="flex justify-between items-center mb-4">
                                                            <h3 className="text-lg font-bold text-gray-800">Resultado do C√°lculo</h3>
                                                            <button
                                                                onClick={() => exportToPDF(calculationResult, calculationSteps)}
                                                                className="btn-pdf text-white px-4 py-2 rounded-lg font-semibold text-sm card-hover transition-all duration-300 flex items-center gap-2"
                                                            >
                                                                <i className="fas fa-file-pdf"></i>
                                                                Exportar PDF
                                                            </button>
                                                        </div>

                                                        <div className="result-card">
                                                            <div className="flex justify-between items-start">
                                                                <div>
                                                                    <h3 className="text-lg font-bold">Resultado do C√°lculo</h3>
                                                                    <p className="text-sm opacity-90">
                                                                        {BRAZILIAN_STATES.find(s => s.value === calculationResult.originState)?.label} ‚Üí 
                                                                        {BRAZILIAN_STATES.find(s => s.value === calculationResult.destinationState)?.label}
                                                                    </p>
                                                                    <p className="text-xs opacity-80 mt-1">
                                                                        M√©todo: {calculationResult.calculationType === 'por_dentro' ? 'Por Dentro' : 'Por Fora'}
                                                                    </p>
                                                                </div>
                                                                <div className="text-right">
                                                                    <p className="text-sm opacity-90">Total a Recolher</p>
                                                                    <div className="result-value">
                                                                        {formatCurrency(calculationResult.totalToPay)}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                                                            <div className="bg-blue-50 p-3 rounded-lg border border-blue-200">
                                                                <p className="text-xs text-blue-700 font-semibold">DIFAL</p>
                                                                <p className="text-lg text-blue-800 font-bold">
                                                                    {formatCurrency(calculationResult.difal)}
                                                                </p>
                                                            </div>
                                                            <div className="bg-green-50 p-3 rounded-lg border border-green-200">
                                                                <p className="text-xs text-green-700 font-semibold">FCP</p>
                                                                <p className="text-lg text-green-800 font-bold">
                                                                    {formatCurrency(calculationResult.fcpValue)}
                                                                </p>
                                                            </div>
                                                            <div className="bg-purple-50 p-3 rounded-lg border border-purple-200">
                                                                <p className="text-xs text-purple-700 font-semibold">Base de C√°lculo</p>
                                                                <p className="text-lg text-purple-800 font-bold">
                                                                    {formatCurrency(calculationResult.icmsBase)}
                                                                </p>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    {/* √Årea Rol√°vel - Detalhamento do C√°lculo */}
                                                    <div className="calculation-content custom-scrollbar mt-4">
                                                        <div className="space-y-3">
                                                            <h4 className="text-md font-bold text-gray-800 mb-3">Passo a Passo do C√°lculo</h4>
                                                            {calculationSteps.map((step, index) => (
                                                                <div key={index} className="calculation-step">
                                                                    <div className="flex justify-between items-start">
                                                                        <div>
                                                                            <h5 className="font-semibold text-gray-800 text-sm">
                                                                                {index + 1}. {step.title}
                                                                            </h5>
                                                                            <p className="text-xs text-gray-600 mt-1">
                                                                                {step.description}
                                                                            </p>
                                                                            <p className="text-xs text-gray-700 mt-1 font-mono">
                                                                                {step.calculation}
                                                                            </p>
                                                                        </div>
                                                                        <div className="text-right">
                                                                            <p className="text-sm font-bold text-blue-700">
                                                                                {step.result}
                                                                            </p>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {/* History View */}
                                    {currentView === 'history' && (
                                        <div className="fade-in">
                                            <div className="flex justify-between items-center mb-4">
                                                <div>
                                                    <h2 className="text-lg font-bold text-gray-800 mb-1">
                                                        Hist√≥rico de C√°lculos
                                                    </h2>
                                                    <p className="text-gray-600 text-sm">
                                                        Total de {calculationHistory.length} c√°lculo(s) realizados
                                                    </p>
                                                </div>
                                                {calculationHistory.length > 0 && (
                                                    <div className="flex gap-2">
                                                        <button
                                                            onClick={exportHistory}
                                                            className="bg-green-500 hover:bg-green-600 text-white px-3 py-1.5 rounded-lg text-sm card-hover transition flex items-center gap-2"
                                                        >
                                                            <i className="fas fa-download"></i>
                                                            Exportar JSON
                                                        </button>
                                                        <button
                                                            onClick={clearHistory}
                                                            className="bg-red-500 hover:bg-red-600 text-white px-3 py-1.5 rounded-lg text-sm card-hover transition flex items-center gap-2"
                                                        >
                                                            <i className="fas fa-trash"></i>
                                                            Limpar
                                                        </button>
                                                    </div>
                                                )}
                                            </div>

                                            {calculationHistory.length === 0 ? (
                                                <div className="text-center py-8 text-gray-500">
                                                    <i className="fas fa-history text-4xl mb-3"></i>
                                                    <p className="text-sm">Nenhum c√°lculo realizado ainda</p>
                                                </div>
                                            ) : (
                                                <div className="space-y-3 max-h-96 overflow-y-auto custom-scrollbar">
                                                    {calculationHistory.map((item) => (
                                                        <div key={item.id} className="bg-gray-50 border border-gray-200 rounded-lg p-3 card-hover">
                                                            <div className="flex justify-between items-start">
                                                                <div className="flex-1">
                                                                    <div className="flex items-center gap-2 mb-1">
                                                                        <i className="fas fa-exchange-alt text-blue-500 text-sm"></i>
                                                                        <span className="font-semibold text-gray-800 text-sm">
                                                                            {BRAZILIAN_STATES.find(s => s.value === item.originState)?.label} ‚Üí 
                                                                            {BRAZILIAN_STATES.find(s => s.value === item.destinationState)?.label}
                                                                        </span>
                                                                        <span className="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded">
                                                                            CFOP: {item.cfop}
                                                                        </span>
                                                                        <span className="text-xs bg-purple-100 text-purple-800 px-2 py-0.5 rounded">
                                                                            {item.calculationType === 'por_dentro' ? 'Por Dentro' : 'Por Fora'}
                                                                        </span>
                                                                    </div>
                                                                    <p className="text-xs text-gray-700 mb-1">
                                                                        Valor: {formatCurrency(item.totalValue)}
                                                                    </p>
                                                                    <div className="flex items-center gap-4 text-xs text-gray-500">
                                                                        <div className="flex items-center gap-1">
                                                                            <i className="fas fa-calculator"></i>
                                                                            <span>DIFAL: {formatCurrency(item.difal)}</span>
                                                                        </div>
                                                                        <div className="flex items-center gap-1">
                                                                            <i className="fas fa-hand-holding-usd"></i>
                                                                            <span>Total: {formatCurrency(item.totalToPay)}</span>
                                                                        </div>
                                                                        <div className="flex items-center gap-1">
                                                                            <i className="fas fa-clock"></i>
                                                                            <span>{new Date(item.calculationDate).toLocaleString('pt-BR')}</span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    {/* Info View */}
                                    {currentView === 'info' && (
                                        <div className="fade-in">
                                            <div className="mb-4">
                                                <h2 className="text-lg font-bold text-gray-800 mb-2">
                                                    Informa√ß√µes sobre o DIFAL
                                                </h2>
                                                <p className="text-gray-600 text-sm">
                                                    Entenda o que √© e como funciona o Diferencial de Al√≠quota
                                                </p>
                                            </div>

                                            <div className="space-y-4">
                                                <div className="tax-info">
                                                    <h3 className="font-bold text-gray-800 text-sm mb-2">O que √© o DIFAL?</h3>
                                                    <p className="text-gray-700 text-sm">
                                                        O Diferencial de Al√≠quota (DIFAL) √© o valor correspondente √† diferen√ßa entre a al√≠quota interna do estado de destino e a al√≠quota interestadual, aplic√°vel nas opera√ß√µes interestaduais com mercadorias sujeitas ao regime normal de tributa√ß√£o.
                                                    </p>
                                                </div>

                                                <div className="bg-blue-50 p-3 rounded-lg border border-blue-200">
                                                    <h3 className="font-bold text-blue-800 text-sm mb-2">Como √© calculado?</h3>
                                                    <p className="text-blue-700 text-sm mb-2">
                                                        O c√°lculo do DIFAL pode ser feito de duas formas:
                                                    </p>
                                                    <div className="space-y-3">
                                                        <div className="bg-white p-3 rounded border border-blue-100">
                                                            <h4 className="font-semibold text-blue-800 text-sm mb-1">C√°lculo por Dentro (M√©todo Correto)</h4>
                                                            <p className="text-blue-700 text-xs">
                                                                1. ICMS Origem = Valor √ó Al√≠quota Interestadual<br/>
                                                                2. Base Ajustada = Valor / (1 - Al√≠quota Interna)<br/>
                                                                3. ICMS Destino = Base Ajustada √ó Al√≠quota Interna<br/>
                                                                4. DIFAL = ICMS Destino - ICMS Origem
                                                            </p>
                                                        </div>
                                                        <div className="bg-white p-3 rounded border border-blue-100">
                                                            <h4 className="font-semibold text-blue-800 text-sm mb-1">C√°lculo por Fora</h4>
                                                            <p className="text-blue-700 text-xs">
                                                                Base de C√°lculo = Valor da Opera√ß√£o<br/>
                                                                DIFAL = (Base √ó Al√≠quota Interna) - (Base √ó Al√≠quota Interestadual)
                                                            </p>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div className="bg-green-50 p-3 rounded-lg border border-green-200">
                                                    <h3 className="font-bold text-green-800 text-sm mb-2">Fundo de Combate √† Pobreza (FCP)</h3>
                                                    <p className="text-green-700 text-sm">
                                                        O FCP √© um adicional aplicado em algumas opera√ß√µes interestaduais, destinado a financiar programas de combate √† pobreza. √â calculado sobre a base de c√°lculo ajustada do ICMS.
                                                    </p>
                                                </div>

                                                <div className="bg-purple-50 p-3 rounded-lg border border-purple-200">
                                                    <h3 className="font-bold text-purple-800 text-sm mb-2">Al√≠quotas Interestaduais</h3>
                                                    <p className="text-purple-700 text-sm">
                                                        As al√≠quotas interestaduais variam conforme os estados envolvidos na opera√ß√£o. Atualmente, a maioria dos estados aplica 12%, exceto Minas Gerais e S√£o Paulo que aplicam 7% em opera√ß√µes entre si.
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Modal de Consulta de Al√≠quotas */}
                    <RatesModal 
                        isOpen={showRatesModal} 
                        onClose={() => setShowRatesModal(false)} 
                    />
                </div>
            );
        }

        // Renderizar a aplica√ß√£o
        ReactDOM.render(<App />, document.getElementById('app'));
    </script>
</body>
</html>